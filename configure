#!/bin/sh

CONFIGURE=YES
COPY_OPTIONS=

OSS_CONFIG_OPTIONS="$*"
export OSS_CONFIG_OPTIONS

# MIDI support is disabled by default. Use --config-midi=YES to enable
CONFIG_MIDI=DISABLED

export CONFIGURE CONFIG_MIDI

unset CDPATH >/dev/null 2>&1

while test  "$# " != "0 "
do
	case "$1" in

   	"--regparm")
		if test "`uname -s` " != "Linux "
		then
			echo $0: --regparm is only valid under Linux
			exit 1
		fi
		echo Will prepare for REGPARM kernels
		export USE_REGPARM=1
		;;

   	"--no-regparm")
		if test "`uname -s` " != "Linux "
		then
			echo $0: --no-regparm is only valid under Linux
			exit 1
		fi
		echo Will prepare for non-REGPARM kernels
		export NO_REGPARM=1
		;;

   	"--target=uclinux-blackfin")
		CROSSCOMPILE=uclinux-blackfin
		uOSS=1
		export CROSSCOMPILE uOSS
		;;

	"--config-vmix=NO")
		VMIX_MODE=DISABLED
		export VMIX_MODE
		;;

	"--config-vmix=FLOAT")
		VMIX_MODE=FLOAT
		export VMIX_MODE
		;;

	"--config-vmix=FIXEDPOINT")
		VMIX_MODE=FIXEDPOINT
		export VMIX_MODE
		;;

	"--config-midi=NO")
		CONFIG_MIDI=DISABLED
		export CONFIG_MIDI
		;;

	"--config-midi=YES")
		CONFIG_MIDI=ENABLED
		export CONFIG_MIDI
		;;

	"--copy-files")
		COPY_OPTIONS="-c"
		;;

	"--include-closed-source")
		CLOSED_SOURCE=YES
		export CLOSED_SOURCE
		;;

	"--enable-libsalsa=NO")
		NOALSA=1
		;;

	"--enable-timings")
		# This is option is undocumented and unsupported. It is only
		# for internal testing by 4Front Technologies and not useful
		# to anybody else.
		DO_TIMINGS="1"
		export DO_TIMINGS
		;;

	*)

		echo $0: Unrecognized command line option $1

		echo
		echo Permitted command line arguments are:
		echo
		
		case `uname -s` in

		Linux)
			echo "   --enable-libsalsa=YES|NO	- Enable/Disable libsalsa."
			echo "   --target=uclinux-blackfin	- Configure for uClinux/Blackfin target (EXPERIMENTAL)"
			echo "   --regparm			- Configure for CONFIG_REGPARM kernels"
			echo "   --no-regparm			- Configure for kernels without CONFIG_REGPARM option."
			echo "NOTE! --regparm/--no-regparm is normally detected"
			echo "      automatically and these switches should NOT be used."
			echo
			;;

		*)
			echo
		esac

		echo "   --config-vmix=NO|FLOAT|FIXEDPOINT	- Configure vmix to use float/int arithmetic or disable it."
		echo "     (Check possible limitations caused by the OS or the CPU/arch)."
		echo "   --config-midi=NO|YES		- Enable/disable MIDI support."
		echo "   --enable-timings		- Enable internal timings (for the readtimings utility)."
		exit 1
	esac

	shift
done

DIR=`pwd`
SRCDIR=`dirname $0`
SRCDIR=`cd $SRCDIR && pwd`
export SRCDIR
export COPY_OPTIONS

if test "$DIR " = " " || test "$DIR " = ". "
then
	echo
	echo
	echo
	echo
	echo
	echo
	echo
	echo
	echo "**** USAGE ERROR ****"
	echo
	echo You need to create an empty build directory and
	echo then execute sh `pwd`/configure inside it.
	echo
	echo Configure script aborted
	exit 2
fi

# Run the OS dependent setup script

case `uname` in

"SunOS")
	case `uname -r` in
	"5.9")
		echo Setting up for Solaris 9
		SOL9=1
		GTK1=1
		export SOL9 GTK1
		;;

	"5.8")
		echo Setting up for Solaris 8
		SOL9=1
		GTK1=1
		export SOL9 GTK1
		;;
	*)
		echo Using Solaris10 specific script
		;;
	esac
	exec sh $SRCDIR/setup/SunOS/solsetup.sh
	;;

"Linux")

	if test "$NOALSA" != "1"
	then
		if test -d /usr/include/alsa || test -d /usr/local/include/alsa
		then
			echo Compiling libsalsa library
			export HAVE_ALSA=1
		fi
	fi
	
	if test "$USE_REGPARM " != "1 " && test "$NO_REGPARM " != "1 "
	then
	  # REGPARM/NOTREGPARM not set so compile a version for both of them
	        echo Using the Linux specific script
		exec sh $SRCDIR/setup/Linux/linsetup.sh
	fi

	echo Using the default script
	exec sh $SRCDIR/setup/setupdir.sh
	;;

*)
	echo Using the default script
	exec sh $SRCDIR/setup/setupdir.sh

esac

echo internal error in configure

exit 3
